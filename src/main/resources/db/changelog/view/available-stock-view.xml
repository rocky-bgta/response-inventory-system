<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">



    <changeSet id="05" author="Salahin Rocky">

        <createView replaceIfExists="true"
                    schemaName="inventory"
                    viewName="available_stock_view">

            SELECT			stock_sum.store_id,
            category.id AS category_id,
            category.name AS category_name,
            stock_sum.product_id,
            product.name AS product_name,
            product.model_no,
            sum(stock_sum.in_total_price_sum) - sum(stock_sum.out_total_price_sum) AS total_price,
            sum(stock_sum.in_qty_sum) - sum(stock_sum.out_qty_sum) AS available_qty
            FROM
            (SELECT
            stock.store_id,
            stock.product_id,
            stock.in_out,
            case stock.in_out when 1 then sum(stock.total) else 0 end as in_total_price_sum,
            case stock.in_out when 2 then sum(stock.total) else 0 end as out_total_price_sum,
            case stock.in_out when 1 then sum(stock.quantity) else 0 end as in_qty_sum,
            case stock.in_out when 2 then sum(stock.quantity) else 0 end as out_qty_sum,
            stock.quantity,
            stock.unit_price,
            stock.total
            FROM stock stock
            GROUP BY
            stock.store_id,
            stock.product_id,
            stock.in_out,
            stock.quantity,
            stock.unit_price,
            stock.total
            )

            stock_sum
            INNER JOIN product product ON product.id = stock_sum.product_id
            INNER JOIN category category ON product.category_id = category.id
            GROUP BY stock_sum.product_id, product.name, product.model_no, category.id, category.name, stock_sum.store_id

        </createView>

    </changeSet>
</databaseChangeLog>
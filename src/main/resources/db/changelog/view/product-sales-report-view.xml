<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">



    <changeSet id="05" author="Salahin Rocky">

        <createView replaceIfExists="true"
                    schemaName="inventory"
                    viewName="product_sales_report_view">
            SELECT
            sales.product_id,
            sales.invoice_no,
            sales.product_name,
            sales.customer_id,
            sales.customer_name,
            sales.buy_price,
            sales.sales_price,
            sales.profit,
            sales.date
            FROM
            (
            SELECT
            sh.product_id,
            p."name" as product_name,
            sh.invoice_no,
            sh.customer_id,
            c.name as customer_name,
            sum(sh.buy_price) as buy_price,
            sum(sh.sales_price) as sales_price,
            sum(sh.sales_price) - sum(sh.buy_price) as profit,
            sh.date

            FROM inventory.sales_history sh
            INNER JOIN inventory.product p ON sh.product_id = p.id
            INNER JOIN inventory.customer c ON sh.customer_id = c.id

            GROUP BY
            sh.invoice_no,
            sh.product_id,
            p.name,
            sh.customer_id,
            c.name,
            sh.date
            ) sales

            <!--WHERE sales.date::DATE BETWEEN '2019-01-05' AND '2019-01-06'-->

            <!--WHERE d.date BETWEEN '2019-01-05 00:00:00' AND '2019-01-06 23:59:59.999999'-->
        </createView>

    </changeSet>
</databaseChangeLog>